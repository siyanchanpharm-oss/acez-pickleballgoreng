<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Acez Pickleball Goreng Session</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #1a237e; --secondary: #3949ab; --accent: #ffc107;
            --bg: #f8f9fa; --card-bg: #ffffff; --text: #333;
            --danger: #dc3545; --success: #28a745;
        }

        body { font-family: -apple-system, system-ui, sans-serif; margin: 0; background: var(--bg); color: var(--text); padding-bottom: 100px; -webkit-tap-highlight-color: transparent; }
        header { background: var(--primary); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .base-indicator { background: var(--secondary); padding: 5px 12px; border-radius: 15px; font-size: 0.85rem; font-weight: bold; }

        nav { position: fixed; bottom: 0; left: 0; width: 100%; background: white; display: flex; border-top: 1px solid #eee; z-index: 1000; height: 75px; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #999; border: none; background: none; font-size: 0.7rem; cursor: pointer; }
        .nav-item.active { color: var(--primary); font-weight: bold; }
        .nav-item i { font-size: 1.3rem; margin-bottom: 4px; }

        /* VIEW TOGGLE LOGIC */
        .view { display: none; padding: 15px; }
        .view.active { display: block; }

        .card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .header-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
        h3 { margin: 0; font-size: 0.85rem; color: #555; text-transform: uppercase; font-weight: 700; }
        
        .inline-score-box { 
            border: 2px solid #2196F3; border-radius: 8px; 
            width: 100px; height: 38px; text-align: center; font-weight: 900; 
            color: #d32f2f; font-size: 1.3rem; background: #fff;
        }

        .selection-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .slot { background: #f0f2f5; border: 1px dashed #cbd5e0; border-radius: 8px; padding: 12px 5px; text-align: center; font-size: 0.85rem; cursor: pointer; min-height: 20px; }
        .slot.selected { background: #e8eaf6; border-style: solid; border-color: var(--secondary); color: var(--primary); font-weight: bold; }
        
        .chip-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin: 15px 0; }
        .chip { background: white; border: 1px solid #ddd; padding: 10px 5px; border-radius: 20px; text-align: center; font-size: 0.8rem; cursor: pointer; }
        .chip.active { background: var(--secondary); color: white; border-color: var(--secondary); }

        .score-scroll { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; padding: 5px; }
        .score-btn { border: 1px solid #ddd; border-radius: 10px; padding: 12px 0; cursor: pointer; display: flex; flex-direction: column; align-items: center; }
        .score-btn b { font-size: 1.3rem; }
        .score-btn small { font-size: 0.65rem; font-weight: bold; }

        .log-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #eee; font-size: 0.85rem; }
        .btn-trash { color: #ccc; border: none; background: none; font-size: 1.1rem; cursor: pointer; }
        .btn-del-tiny { color: var(--danger); background: none; border: none; font-size: 1rem; cursor: pointer; }
        
        table { width: 100%; border-collapse: collapse; }
        td, th { padding: 12px 5px; border-bottom: 1px solid #f5f5f5; font-size: 0.85rem; text-align: left; }
        .win-badge { background: #e8f5e9; color: #2e7d32; padding: 2px 6px; border-radius: 4px; font-weight: bold; font-size: 0.75rem; margin-left: 5px; }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 3000; align-items: center; justify-content: center; }
        .modal { background: white; width: 85%; max-width: 400px; border-radius: 16px; padding: 20px; text-align: center; }
        input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 1rem; }
    </style>
</head>
<body>

<header>
    <div>
        <h2 id="sessionNameHeader" style="margin:0; font-size: 0.95rem;">Acez PB Goreng Session</h2>
        <div id="dateLine" style="font-size: 0.7rem; opacity: 0.8;"></div>
    </div>
    <div id="headerBaseDisplay" class="base-indicator">RM10 Base</div>
</header>

<div id="confirmModal" class="modal-overlay">
    <div class="modal">
        <h3>Save Game?</h3>
        <div id="confirmDetail" style="background:#f8f9fa; border-radius:8px; padding:15px; margin-bottom:20px; line-height:1.6; text-align:left;"></div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <button onclick="closeConfirm()" style="padding:12px; border:none; border-radius:8px; background:#eee;">Cancel</button>
            <button onclick="commitGame()" style="background:var(--success); color:white; padding:12px; border:none; border-radius:8px; font-weight:bold;">Confirm</button>
        </div>
    </div>
</div>

<div id="view-play" class="view active">
    <div class="card selection-grid">
        <div>
            <div class="header-row">
                <h3>Winners</h3>
                <input type="number" id="winScoreInput" value="11" class="inline-score-box">
            </div>
            <div id="slot-w1" class="slot" onclick="handleSlotClick('w1')">Select</div>
            <div id="slot-w2" class="slot" onclick="handleSlotClick('w2')">Select</div>
        </div>
        <div>
            <div class="header-row"><h3>Losers</h3></div>
            <div id="slot-l1" class="slot" onclick="handleSlotClick('l1')">Select</div>
            <div id="slot-l2" class="slot" onclick="handleSlotClick('l2')">Select</div>
        </div>
    </div>
    <div id="activeChips" class="chip-container"></div>
    <div class="card">
        <h3>Select Loser Score (0-11)</h3>
        <div id="scoreGrid" class="score-scroll"></div>
        <div style="padding-top:15px; border-top:1px solid #eee; margin-top:15px;">
            <h3>Manual Score (Deuce)</h3>
            <div style="display:flex; gap:10px;">
                <input type="number" id="manualScoreInput" placeholder="Deuce score" style="flex:1;">
                <button onclick="handleManualScore()" style="background:var(--secondary); color:white; border:none; padding:0 20px; border-radius:8px; font-weight:bold;">Add</button>
            </div>
        </div>
    </div>
</div>

<div id="view-logs" class="view">
    <div class="card">
        <h3>Current Session Log</h3>
        <div id="currentLogList" style="max-height: 200px; overflow-y: auto; margin-bottom:10px;"></div>
        <button onclick="shareWhatsApp()" style="background:#25D366; color:white; border:none; padding:12px; border-radius:8px; font-weight:bold; width:100%; display:flex; align-items:center; justify-content:center; gap:8px;">
            <i class="fab fa-whatsapp"></i> Share Standings
        </button>
    </div>
    <div class="card">
        <h3>Archives</h3>
        <div style="display:flex; gap:10px; margin-bottom:15px;">
            <input type="text" id="archiveNameInput" placeholder="Archive Name">
            <button onclick="saveToArchive()" style="background:var(--primary); color:white; border:none; padding:10px 15px; border-radius:8px; font-weight:bold;">Save</button>
        </div>
        <div id="archiveList"></div>
    </div>
</div>

<div id="view-net" class="view">
    <div class="card">
        <h3>Session Leaderboard</h3>
        <table id="leaderboardTable">
            <thead><tr><th>Player</th><th style="text-align:right">Net RM</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<div id="view-roster" class="view">
    <div class="card">
        <h3>Master Roster</h3>
        <div id="masterListCheckboxes" style="margin-bottom:15px; max-height:200px; overflow-y:auto; border:1px solid #eee; border-radius:8px;"></div>
        <div style="display:flex; gap:10px;">
            <input type="text" id="newPlayerName" placeholder="New Player Name">
            <button onclick="addNewPlayer()" style="background:var(--primary); color:white; border:none; padding:10px; border-radius:8px;">Add</button>
        </div>
    </div>
    <div class="card">
        <h3>Settings</h3>
        <label style="font-size:0.8rem; font-weight:bold;">Base Bet (RM)</label>
        <input type="number" id="baseBetInput" onchange="updateRules()" style="margin-bottom:15px;">
        <button onclick="clearBoard()" style="width:100%; background:#ffebee; color:var(--danger); border:none; padding:15px; border-radius:8px; font-weight:bold;">RESET ACTIVE BOARD</button>
    </div>
</div>

<nav>
    <button class="nav-item active" onclick="switchTab('play')"><i class="fas fa-trophy"></i><span>Play</span></button>
    <button class="nav-item" onclick="switchTab('logs')"><i class="fas fa-folder-open"></i><span>Logs</span></button>
    <button class="nav-item" onclick="switchTab('net')"><i class="fas fa-chart-line"></i><span>Net RM</span></button>
    <button class="nav-item" onclick="switchTab('roster')"><i class="fas fa-users"></i><span>Roster</span></button>
</nav>

<script>
    let appData = JSON.parse(localStorage.getItem('acez_vFinal_26')) || {
        master: ["Acez"],
        today: ["Acez"],
        base: 10,
        active: { name: "New Session", history: [] },
        archive: [],
        selections: { w1: null, w2: null, l1: null, l2: null },
        activeSlot: 'w1'
    };

    let pendingGame = null;

    function save() { localStorage.setItem('acez_vFinal_26', JSON.stringify(appData)); render(); }

    function switchTab(id) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById('view-' + id).classList.add('active');
        event.currentTarget.classList.add('active');
    }

    function handleSlotClick(s) { appData.activeSlot = s; save(); }

    function selectPlayer(name) {
        for(let k in appData.selections) if(appData.selections[k] === name) appData.selections[k] = null;
        appData.selections[appData.activeSlot] = name;
        const seq = {w1:'w2', w2:'l1', l1:'l2', l2:'w1'};
        appData.activeSlot = seq[appData.activeSlot];
        save();
    }

    function openConfirm(score) {
        if(!appData.selections.w1 || !appData.selections.l1) return alert("Select Players!");
        const winS = document.getElementById('winScoreInput').value;
        const mult = score === 0 ? 5 : (score <= 3 ? 3 : (score <= 6 ? 2 : 1));
        const payout = appData.base * mult;
        pendingGame = {
            w: [appData.selections.w1, appData.selections.w2].filter(x=>x),
            l: [appData.selections.l1, appData.selections.l2].filter(x=>x),
            score: `${winS}-${score}`,
            payout: payout
        };
        document.getElementById('confirmDetail').innerHTML = `<b>Winners:</b> ${pendingGame.w.join('/')} (${winS})<br><b>Losers:</b> ${pendingGame.l.join('/')} (${score})<br><b>Payout:</b> RM ${payout}`;
        document.getElementById('confirmModal').style.display = 'flex';
    }

    function handleManualScore() {
        const val = parseInt(document.getElementById('manualScoreInput').value);
        if(isNaN(val)) return alert("Enter valid score");
        openConfirm(val);
        document.getElementById('manualScoreInput').value = '';
    }

    function closeConfirm() { document.getElementById('confirmModal').style.display = 'none'; }

    function commitGame() {
        appData.active.history.push(pendingGame);
        appData.selections = { w1: null, w2: null, l1: null, l2: null };
        appData.activeSlot = 'w1';
        closeConfirm(); save();
    }

    function deleteGame(idx) { if(confirm("Delete game?")) { appData.active.history.splice(idx, 1); save(); } }
    function saveToArchive() {
        const name = document.getElementById('archiveNameInput').value.trim();
        if(!name) return alert("Enter name!");
        appData.active.name = name;
        appData.active.date = new Date().toLocaleDateString();
        appData.archive.push(JSON.parse(JSON.stringify(appData.active)));
        alert("Archived!"); save();
    }

    function loadArchive(idx) {
        if(confirm("Load this session?")) { appData.active = JSON.parse(JSON.stringify(appData.archive[idx])); save(); switchTab('play'); }
    }

    function deleteArchive(idx) { if(confirm("Delete archive?")) { appData.archive.splice(idx, 1); save(); } }
    function clearBoard() { if(confirm("Clear current board?")) { appData.active.history = []; save(); } }
    function updateRules() { appData.base = parseInt(document.getElementById('baseBetInput').value) || 10; save(); }
    
    function addNewPlayer() {
        const name = document.getElementById('newPlayerName').value.trim();
        if(name && !appData.master.includes(name)) { appData.master.push(name); appData.today.push(name); document.getElementById('newPlayerName').value=''; save(); }
    }
    
    function deleteMasterPlayer(n) { if(confirm(`Delete ${n}?`)) { appData.master = appData.master.filter(p=>p!==n); appData.today = appData.today.filter(p=>p!==n); save(); } }
    function toggleToday(n) { if(appData.today.includes(n)) appData.today = appData.today.filter(x=>x!==n); else appData.today.push(n); save(); }

    function shareWhatsApp() {
        let stats = {}; appData.today.forEach(p=>stats[p]={rm:0,w:0,l:0});
        appData.active.history.forEach(g=>{ 
            g.w.forEach(p=>{ if(stats[p]) {stats[p].rm+=g.payout; stats[p].w++;} }); 
            g.l.forEach(p=>{ if(stats[p]) {stats[p].rm-=g.payout; stats[p].l++;} }); 
        });
        let text = `ðŸ† *Acez PB Goreng Standings*\n\n`;
        Object.entries(stats).sort((a,b)=>b[1].rm-a[1].rm).forEach(([n,s]) => {
            text += `${s.rm>=0?'ðŸŸ¢':'ðŸ”´'} *${n}*: RM ${s.rm.toFixed(2)} (${s.w}W-${s.l}L)\n`;
        });
        window.open(`https://wa.me/?text=${encodeURIComponent(text)}`);
    }

    function render() {
        document.getElementById('sessionNameHeader').innerText = appData.active.name;
        document.getElementById('headerBaseDisplay').innerText = `RM${appData.base} Base`;
        document.getElementById('baseBetInput').value = appData.base;
        document.getElementById('dateLine').innerText = new Date().toLocaleDateString();

        ['w1','w2','l1','l2'].forEach(s => {
            const el = document.getElementById('slot-' + s);
            el.innerText = appData.selections[s] || 'Select';
            el.className = 'slot' + (appData.activeSlot === s ? ' selected' : '');
        });

        const chips = document.getElementById('activeChips');
        chips.innerHTML = '';
        appData.today.forEach(p => { chips.innerHTML += `<div class="chip ${Object.values(appData.selections).includes(p)?'active':''}" onclick="selectPlayer('${p}')">${p}</div>`; });

        const grid = document.getElementById('scoreGrid');
        grid.innerHTML = '';
        for(let i=0; i<=11; i++) {
            let color = "#ffffff"; let border = "#e0e0e0"; let txt = "#424242";
            if(i === 0) { color = "#f3e5f5"; border = "#ce93d8"; txt = "#6a1b9a"; } // Purple
            else if(i <= 3) { color = "#fff3e0"; border = "#ffcc80"; txt = "#ef6c00"; } // Orange
            else if(i <= 6) { color = "#fffde7"; border = "#fff59d"; txt = "#f9a825"; } // Yellow
            const mult = i === 0 ? 5 : (i <= 3 ? 3 : (i <= 6 ? 2 : 1));
            grid.innerHTML += `<button class="score-btn" style="background-color:${color}; border-color:${border}; color:${txt};" onclick="openConfirm(${i})"><b>${i}</b><small>RM${appData.base * mult}</small></button>`;
        }

        const logList = document.getElementById('currentLogList');
        logList.innerHTML = '';
        appData.active.history.slice().reverse().forEach((g, i) => {
            const realIdx = appData.active.history.length - 1 - i;
            logList.innerHTML += `<div class="log-item"><span><b>${g.w.join('/')}</b> vs ${g.l.join('/')} (${g.score}) - RM${g.payout}</span><button class="btn-del-tiny" onclick="deleteGame(${realIdx})"><i class="fas fa-trash-alt"></i></button></div>`;
        });

        const lb = document.querySelector('#leaderboardTable tbody');
        lb.innerHTML = '';
        let stats = {}; appData.today.forEach(p=>stats[p]={rm:0,w:0,l:0});
        appData.active.history.forEach(g=>{ 
            g.w.forEach(p=>{ if(stats[p]) {stats[p].rm+=g.payout; stats[p].w++;} }); 
            g.l.forEach(p=>{ if(stats[p]) {stats[p].rm-=g.payout; stats[p].l++;} }); 
        });
        Object.entries(stats).sort((a,b)=>b[1].rm-a[1].rm).forEach(([n,s]) => {
            lb.innerHTML += `<tr><td>${n} <span class="win-badge">${s.w}W-${s.l}L</span></td><td style="text-align:right; font-weight:bold; color:${s.rm>=0?'var(--success)':'var(--danger)'}">RM ${s.rm.toFixed(2)}</td></tr>`;
        });

        const arch = document.getElementById('archiveList');
        arch.innerHTML = '';
        appData.archive.slice().reverse().forEach((s, idx) => {
            const realIdx = appData.archive.length - 1 - idx;
            arch.innerHTML += `<div class="log-item"><span>${s.name} (${s.date})</span><div><button onclick="loadArchive(${realIdx})" style="background:var(--secondary); color:white; border:none; padding:5px 10px; border-radius:4px;">Load</button><button onclick="deleteArchive(${realIdx})" style="color:var(--danger); border:none; background:none; padding-left:10px;"><i class="fas fa-trash"></i></button></div></div>`;
        });

        const master = document.getElementById('masterListCheckboxes');
        master.innerHTML = '';
        appData.master.forEach(p => {
            master.innerHTML += `<div class="log-item" style="padding:10px;"><span>${p}</span><div><button onclick="deleteMasterPlayer('${p}')" style="color:#ccc; border:none; background:none; padding-right:15px;"><i class="fas fa-trash-alt"></i></button><button onclick="toggleToday('${p}')" style="background:${appData.today.includes(p)?'#28a745':'#eee'}; border:none; border-radius:50%; width:28px; height:28px; color:white;">${appData.today.includes(p)?'âœ“':''}</button></div></div>`;
        });
    }

    render();
</script>
</body>
</html>